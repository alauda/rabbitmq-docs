---
weight: 30
i18n:
  title:
    en: Concepts
---

# 核心概念

## 交换器

交换器存在多种类型，以满足不同模式的消息分发模型。

### Direct 交换器

直接（direct）交换器根据消息路由键将消息传递到队列。直接交换对于消息的单播路由是理想的，同时也可用于多播路由。

工作原理如下：

* 队列通过路由键 K 绑定到交换机
* 当具有路由密钥 R 的新消息到达直接交换机时，如果 K = R，则交换机将其路由到队列
* 如果多个队列绑定到具有相同路由键 K 的直接交换机，则交换机会将消息路由到 K = R 的所有队列

![direct 消息分发器](./assets/rabbitmq-exchange-direct.png)

### Fanout 交换器

扇出（fanout）交换将消息路由到与其绑定的所有队列，并且路由键将被忽略。如果 N 个队列绑定到扇出交换器，则当新消息发布到该交换器时，该消息的副本将传递到所有 N 个队列。扇出交换器非常适合消息的广播路由。

由于扇出交换将消息的副本传递到与其绑定的每个队列，因此其用例非常相似：

* 大型多人在线 (MMO) 游戏可以使用它来更新排行榜或其他全球活动
* 体育新闻网站可以使用扇出交换将分数更新近乎实时地分发给移动客户端
* 分布式系统可以广播各种状态和配置更新
* 群聊可以使用扇出交换在参与者之间分发消息（尽管 AMQP 没有内置的存在概念，因此 XMPP 可能是更好的选择）

![fanout 消息分发器](./assets/rabbitmq-exchange-fanout.png)


### Topic 交换器

主题（topic）交换器根据消息路由键与用于将队列绑定到交换器的模式之间的匹配，将消息路由到一个或多个队列。主题交换类型通常用于实现各种发布/订阅模式变体。主题交换通常用于消息的多播路由。

主题交换有非常广泛的用例。每当问题涉及多个消费者/应用程序选择性地选择他们想要接收的消息类型时，就应该考虑使用主题交换。

### Headers 交换器

标头（headers）交换设计用于在多个属性上进行路由，这些属性比路由键更容易表示为消息标头。标头交换忽略路由键属性。相反，用于路由的属性取自 headers 属性。如果标头的值等于绑定时指定的值，则消息被视为匹配。

可以使用多个标头将队列绑定到标头交换以进行匹配。在这种情况下，代理需要应用程序开发人员提供另一条信息，即它应该考虑具有任何标头匹配的消息，还是所有标头匹配的消息？这就是“x-match”绑定参数的用途。当“x-match”参数设置为“any”时，只需一个匹配的标头值。或者，将“x-match”设置为“all”强制所有值必须匹配。

## 队列

AMQP 0-9-1 模型中的队列与其他消息和任务队列系统中的队列非常相似：它们存储应用程序使用的消息。队列与交换器共享一些属性，但也有一些附加属性：

* 名称
* 持久：队列将在代理重新启动后继续存在
* 独占：仅由一个连接使用，当该连接关闭时队列将被删除
* 自动删除：当最后一个消费者取消订阅时，至少有一个消费者的队列将被删除
* 参数：可选，由插件和特定于代理的功能使用，例如消息 TTL、队列长度限制等

在使用队列之前，必须先声明它。如果队列尚不存在，则声明队列将导致创建它。如果队列已经存在并且其属性与声明中的属性相同，则声明无效。当现有队列属性与声明中的属性不同时，将引发代码 406 (PRECONDITION_FAILED) 的通道级异常。

## 绑定

绑定是指将消息从交换器路由到队列的规则。为了使交换器 E 能够将消息路由到队列 Q，需要将队列 Q 绑定到交换器 E。绑定可以具有一些可选的路由键属性，这些属性由某些交换器类型使用。路由键的作用是根据特定的规则选择将消息发布到交换器时需要路由到的绑定队列。路由键就像一个过滤器，帮助确定消息的路由路径。

拥有这一间接层可以实现使用直接发布到队列的方式不可能或很难实现的路由方案，并且还消除了应用程序开发人员必须执行的一定量的重复工作。

如果消息无法路由到任何队列（例如，因为没有与其发布到的交换器的绑定），则该消息将被删除或返回给发布者，具体取决于发布者设置的消息属性。

