---
weight: 60
i18n:
  title:
    en: Plugin
---

# 插件支持

## 插件机制

RabbitMQ 支持插件，插件以多种方式扩展功能：支持更多协议、系统状态监控、额外的 AMQP 0-9-1 交换类型、节点联邦等等，许多功能以插件的形式实现，并随核心发行版本一同提供。

更多介绍可参考：[https://www.rabbitmq.com/docs/plugins#overview](https://www.rabbitmq.com/docs/plugins#overview)

## 操作说明

### 查看实例下所支持的插件

选择 RabbitMQ 实例的任一节点，进入 Pod 中，执行以下命令以查看插件支持与启用状态：

```
rabbitmq-plugins list
```

创建实例时，会默认开启 `rabbitmq_peer_discovery_k8s`、`rabbitmq_prometheus`、`rabbitmq_management` 及其相关插件。

以下是镜像中所带有的插件以及说明：

| 插件名称 | 说明  |
| --- | --- |
| **rabbitmq_amqp1_0** | 用于支持 AMQP 1.0 协议的插件，可以用 AMQP 1.0 的客户端来连接 RabbitMQ |
| **rabbitmq_auth_backend_cache** | 用于缓存认证结果的插件，可以提高 RabbitMQ 的认证性能，减少对后端认证服务的请求 |
| **rabbitmq_auth_backend_http** | 用于支持 HTTP 认证的插件，可以用 HTTP 服务来验证 RabbitMQ 的用户 |
| **rabbitmq_auth_backend_ldap** | 用于支持 LDAP 认证的插件，可以用 LDAP 服务来验证 RabbitMQ 的用户 |
| **rabbitmq_auth_backend_oauth2** | 用于支持 OAuth 2.0 认证的插件，可以用 OAuth 2.0 服务来验证 RabbitMQ 的用户 |
| **rabbitmq_auth_mechanism_ssl** | 用于支持 SSL 认证的插件，可以用 SSL 证书来验证 RabbitMQ 的用户 |
| **rabbitmq_consistent_hash_exchange** | 用于实现一致性哈希的插件，可以让你创建一种特殊的交换器，根据消息的路由键或头部来计算哈希值，然后将消息发送到对应的队列 |
| **rabbitmq_delayed_message_exchange** | 实现延迟消息的插件，可以让你创建一种特殊的交换器，根据消息的头部来设置延迟时间，然后将消息暂存到内存或磁盘，等到延迟时间到了，再将消息发送到对应的队列 |
| **rabbitmq_event_exchange** | 用于发布 RabbitMQ 的事件的插件，可以让你创建一种特殊的交换器，将 RabbitMQ 的各种事件，如连接，通道，队列，用户，权限等的创建，删除，修改等，作为消息发送到对应的队列，支持多种事件类型和过滤选项 |
| **rabbitmq_federation** | 用于连接多个 RabbitMQ 的插件，可以让你创建一些联合，将消息从一个 RabbitMQ 转发到另一个 RabbitMQ |
| **rabbitmq_federation_management** | 用于管理 RabbitMQ federation的插件，可以让你在 Web 界面上查看和配置 RabbitMQ 的联合 |
| **rabbitmq_jms_topic_exchange** | 用于支持 JMS 主题的插件，可以让你创建一种特殊的交换器，根据消息的 JMSDestination 头部来路由消息 |
| **rabbitmq_management** | 用于管理和监控 RabbitMQ 的插件，提供了一个 Web 界面，可以让你查看 RabbitMQ 的状态，配置，统计，日志等信息，也可以让你执行一些操作 |
| **rabbitmq_management_agent** | 用于支持 RabbitMQ 管理的插件，提供了一个代理，可以让 RabbitMQ 的节点向管理插件报告各种信息，如内存，磁盘，连接，通道，队列等的使用情况，也可以让管理插件向 RabbitMQ 的节点发送各种命令 |
| **rabbitmq_mqtt** | 用于支持 MQTT 协议的插件，可以让你用 MQTT 的客户端来连接 RabbitMQ，支持多种特性，如 QoS，保留消息，遗嘱消息，主题过滤等 |
| **rabbitmq_peer_discovery_aws** | 用于支持 AWS 的节点发现的插件，可以在 AWS 的环境中自动发现和加入 RabbitMQ 的集群，支持多种 AWS 的服务 |
| **rabbitmq_peer_discovery_common** | 用于支持通用的节点发现的插件，提供了一些基础的功能，如节点的注册，注销，查询等，可以被其他的节点发现插件使用 |
| **rabbitmq_peer_discovery_consul** | 用于支持 Consul 的节点发现的插件，可以在 Consul 的环境中自动发现和加入 RabbitMQ 的集群 |
| **rabbitmq_peer_discovery_etcd** | 用于支持 etcd 的节点发现的插件，可以在 etcd 的环境中自动发现和加入 RabbitMQ 的集群 |
| **rabbitmq_peer_discovery_k8s** | 用于支持 Kubernetes 的节点发现的插件，它可以让你在 Kubernetes 的环境中自动发现和加入 RabbitMQ 的集群 |
| **rabbitmq_prometheus** | 用于支持 Prometheus 的监控的插件，它可以让你用 Prometheus 来收集和展示 RabbitMQ 的各种指标 |
| **rabbitmq_random_exchange** | 用于实现随机路由的插件，它可以让你创建一种特殊的交换器，将消息随机发送到一个或多个队列 |
| **rabbitmq_recent_history_exchange** | 用于实现最近历史路由的插件，它可以让你创建一种特殊的交换器，将消息发送到最近发送过的一个或多个队列 |
| **rabbitmq_sharding** | 用于实现分片的插件，可以让你创建一种特殊的队列，将消息分散到多个子队列 |
| **rabbitmq_shovel** | 用于转发消息的插件，可以让你定义一些规则，将消息从一个队列或交换器转发到另一个队列或交换器 |
| **rabbitmq_shovel_management** | 用于管理 RabbitMQ shovel的插件，可以让你在 Web 界面上查看和配置 RabbitMQ shovel |
| **rabbitmq_stomp** | 用于支持 STOMP 协议的插件，可以让你用 STOMP 的客户端来连接 RabbitMQ，支持多种特性 |
| **rabbitmq_stream** | 用于支持流协议的插件，可以让你创建一种特殊的队列，用于存储和传输大量的有序的消息 |
| **rabbitmq_stream_management** | 用于管理 RabbitMQ stream的插件，可以让你在 Web 界面上查看和配置 RabbitMQ stream |
| **rabbitmq_top** | 用于查看 RabbitMQ 的性能的插件，提供了一个命令行界面，可以让你查看 RabbitMQ 的各种资源的使用情况 |
| **rabbitmq_tracing** | 用于追踪 RabbitMQ 的消息的插件，可以创建一些追踪，将 RabbitMQ 的消息的内容和属性记录到文件或日志中 |
| **rabbitmq_trust_store** | 用于管理 RabbitMQ 的信任存储的插件，它可以让你在 RabbitMQ 中存储和更新 SSL 证书 |
| **rabbitmq_web_dispatch** | 用于支持 RabbitMQ 的 Web 服务的插件，它提供了一个框架，可以让你在 RabbitMQ 中定义和处理 HTTP 请求 |
| **rabbitmq_web_mqtt** | 用于支持 MQTT over WebSockets 的插件，它可以让你用 WebSockets 的客户端来连接 RabbitMQ |
| **rabbitmq_web_mqtt_examples** | 用于演示 MQTT over WebSockets 的插件，提供了一些示例 |
| **rabbitmq_web_stomp** | 用于支持 STOMP over WebSockets 的插件，可以让你用 WebSockets 的客户端来连接 RabbitMQ |
| **rabbitmq_web_stomp_examples** | 用于演示 STOMP over WebSockets 的插件，提供了一些示例 |

### 启用/停用镜像中已带有的插件

当您需要启用或停用镜像中已带有的插件时，可以更新实例的 YAML 相关字段，以 rabbitmq_shovel 为例：

```yaml
additionalPlugins:
- rabbitmq_top
- rabbitmq_shovel
```

### 启用第三方或自定义的插件

当您需要启用不包含在镜像中的自定义插件或者社区新插件，无法直接更改 YAML 中的 additionalPlugins  启用，需要在 pod 启动前先下载到容器中，。

#### 方式一：环境可访问外网

1.  更新 spec.override 字段，增加 sts 的配置，在 initContainer 中下载插件。
2.  更新 spec.rabbitmq.envConfig 字段，增加环境变量，配置插件的路径。
3.  更新 spec.rabbitmq.additionalPlugins 字段，开启插件。
4.  实例就绪后使用 rabbitmq-plugins list 命令查看插件是否启用。

YAML 示例如下：

```yaml
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: test
  namespace: yh-test2
  labels:
    prometheus.io/port: "15692"
    prometheus.io/scrape: "true"
spec:
  version: 3.12.4
  replicas: 3
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "1"
      memory: 2Gi
  service:
    type: NodePort
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/name: test
          topologyKey: kubernetes.io/hostname
  rabbitmq:
    additionalPlugins:
      - rabbitmq_management_exchange
    envConfig: |
      RABBITMQ_PLUGINS_DIR=/opt/rabbitmq/plugins:/opt/rabbitmq/community-plugins
  override:
    statefulSet:
      spec:
        template:
          spec:
            containers:
              - name: rabbitmq
                volumeMounts:
                  - mountPath: /opt/rabbitmq/community-plugins
                    name: community-plugins
            volumes:
              - name: community-plugins
                emptyDir: {}
            initContainers:
              - command:
                  - sh
                  - -c
                  - curl -L -v https://github.com/rabbitmq/rabbitmq-management-exchange/releases/download/v3.12.0/rabbitmq_management_exchange-3.12.0.ez --output /community-plugins/rabbitmq_management_exchange-3.12.0.ez
                image: curlimages/curl  #或者其他带curl命令的镜像
                imagePullPolicy: IfNotPresent
                name: copy-community-plugins
                resources:
                  limits:
                    cpu: 100m
                    memory: 500Mi
                  requests:
                    cpu: 100m
                    memory: 500Mi
                terminationMessagePolicy: FallbackToLogsOnError
                volumeMounts:
                  - mountPath: /community-plugins/
                    name: community-plugins
  persistence:
    storageClassName: aaaaaa
    storage: 1Gi
```

#### 方式二：环境无法访问外网

1.  更新 spec.override 字段，增加 sts 的配置，通过 hostpath 挂载插件到容器中。要确保实例调度的节点上的文件夹存在（示例中为/root/yh/community-plugins），并且有放入插件。
2.  更新 spec.rabbitmq.envConfig 字段，增加环境变量，配置插件的路径。
3.  更新 spec.rabbitmq.additionalPlugins 字段，开启插件。
4.  实例就绪后使用 rabbitmq-plugins list 命令查看插件是否启用。

YAML 示例如下：

```yaml
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: test
  namespace: yh-test2
  labels:
    prometheus.io/port: "15692"
    prometheus.io/scrape: "true"
spec:
  version: 3.12.4
  replicas: 3
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "1"
      memory: 2Gi
  service:
    type: NodePort
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/name: test
          topologyKey: kubernetes.io/hostname
  rabbitmq:
    additionalPlugins:
      - rabbitmq_management_exchange
    envConfig: |
      RABBITMQ_PLUGINS_DIR=/opt/rabbitmq/plugins:/opt/rabbitmq/community-plugins
  override:
    statefulSet:
      spec:
        template:
          spec:
            containers:
              - name: rabbitmq
                resources: {}
                volumeMounts:
                  - mountPath: /opt/rabbitmq/community-plugins
                    name: community-plugins
            initContainers:
              - command:
                  - sh
                  - -c
                  - cp -r /temp-plugins/* /community-plugins/ && chown 999:999
                    /community-plugins/* && chmod 755 /community-plugins/*
                image: registry.alauda.cn:60080/middleware/rabbitmq/rabbitmq3124-management:v3.15.0 # 镜像其他镜像也可
                name: copy-community-plugins
                resources: {}
                securityContext:
                  privileged: true
                  runAsGroup: 0
                  runAsUser: 0
                volumeMounts:
                  - mountPath: /community-plugins/
                    name: community-plugins
                  - mountPath: /temp-plugins/
                    mountPropagation: Bidirectional
                    name: temp-plugins
            volumes:
              - emptyDir: {}
                name: community-plugins
              - hostPath:
                  path: /root/yh/community-plugins # 主机上的插件目录
                  type: Directory
                name: temp-plugins
  persistence:
    storageClassName: aaaaaa
    storage: 1Gi
```

## 升级影响说明

*   当您的实例需要升级时，请确保升级前后的实例配置中都启用了相关插件，以确保功能正常。
*   如果社区中有废弃插件时，需要您及时下线废弃插件。
*   通过自定义或第三方启用的插件，请您确保各版本间的兼容性。
