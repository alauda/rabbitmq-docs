---
weight: 10
sourceSHA: 6d326949f0b3201ab096231335a84c813df96118db1383986bc0b2fc36486661
---

# 创建实例

RabbitMQ 是一个流行的消息队列中间件，具有高效且可靠的消息异步传递机制。它主要用于不同系统之间的数据交换与传输，广泛应用于企业解决方案、金融支付、电信、电子商务、社交网络、即时消息、视频、物联网及车联网等多个领域。

在当前版本中，支持以下版本的 RabbitMQ： `3.8.16` 和 `3.12`。在创建实例时，只能选择这两个版本。实例创建过程将以 `3.12` 为例。

<Directive type="tip" title="版本建议">
  在选择版本时，建议选择最新支持的版本。`3.12` 具有以下优势：

  1. `3.12` 支持生产就绪的集群队列；此外，社区修复了许多错误，性能在 `3.12` 中得到了大幅提升。
  2. `3.8.x` 将逐步被淘汰。如果您当前正在使用 `3.8.x` 系列，后续需要版本升级，可能会影响业务操作。
</Directive>

## 创建 RabbitMQ 实例

### 前提条件

- 请确保当前集群中有可用的存储类，并且有足够的可用空间。

### 步骤

<Tabs>
  <Tab label="命令行">
    通过命令行创建 RabbitMQ 实例：

    ```bash
    $ cat << EOF | kubectl -n default create -f -
    apiVersion: rabbitmq.com/v1beta1
    kind: RabbitmqCluster
    metadata:
      name: rrrr
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: cluster-in
              topologyKey: kubernetes.io/hostname
      persistence:
        storage: 1Gi
        storageClassName: sc-topolvm
      rabbitmq:
        additionalConfig: |-
          channel_max=1000
          cluster_keepalive_interval=10000
          collect_statistics=none
          collect_statistics_interval=5000
          default_vhost=/
          delegate_count=16
          disk_free_limit.absolute=50MB
          handshake_timeout=10000
          heartbeat=60
          max_message_size=134217728
          mirroring_sync_batch_size=4096
          mnesia_table_loading_retry_limit=10
          mnesia_table_loading_retry_timeout=30000
          num_acceptors.tcp=10
          queue_index_embed_msgs_below=4096
          raft.wal_max_size_bytes=64000000
          vm_memory_calculation_strategy=allocated
          vm_memory_high_watermark.relative=0.4
          vm_memory_high_watermark_paging_ratio=0.5
      replicas: 3
      resources:
        limits:
          cpu: 1
          memory: 2Gi
        requests:
          cpu: 1
          memory: 2Gi
      service:
        type: ClusterIP
      upgradeOption:
        autoUpgrade: false
      version: "3.12"
    EOF
    ```

    > 有关详细字段信息，请参阅 [RabbitMQ API 文档](../apis/kubernetes_apis/rabbitmq/rabbitmq)。

    实例创建后，您可以使用以下命令查看实例：

    ```bash
    $ kubectl -n default get rabbitmqclusters
    NAME   AGE
    rrrr   74s
    ```

    您可以使用以下自定义命令批量查看实例状态：

    ```bash
    $ kubectl -n default get rabbitmqclusters rrrr -o custom-columns='NAME:.metadata.name,PHASE:.status.phase,USER SECRET:.status.defaultUser.secretReference.name'
    NAME   PHASE    USER SECRET
    rrrr   Active   rrrr-default-user
    ```

    输出表格字段的含义如下：

    | 字段        | 描述                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
    | :---------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | NAME        | 实例名称                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
    | PHASE       | 实例状态，可能处于以下几种状态： <ul><li>`Creating`: 实例正在创建资源并初始化集群</li><li>`Updating`: 实例配置正在更新中</li><li>`Active`: 实例处于服务状态</li><li>`Failed`: 实例在初始化或更新过程中遇到错误</li><li>`Unknown`: 实例处于未知状态</li><li>`Paused`: 实例已暂停，相关 Pods 已被关闭</li></ul>                                                                        |
    | USER SECRET | 存储默认用户帐户信息的密钥                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
  </Tab>

  <Tab label="Web 控制台">
    1. 在左侧导航栏中，点击 **RabbitMQ**。

    2. 点击 ***命名空间名称***。

    3. 点击 **创建 RabbitMQ 实例**。

    4. 请参照以下说明配置相关参数。

    <table>
      <tr>
        <th nowrap>配置</th>
        <th>参数项</th>
        <th>描述</th>
      </tr>

      <tr>
        <td><b>参数配置</b></td>
        <td><b>参数模板</b></td>
        <td>可以选择系统或者自定义参数模板；对于自定义模板，请参阅 <a href="">参数模板</a>。</td>
      </tr>

      <tr>
        <td nowrap><b>资源配置</b></td>
        <td><b>存储类</b></td>
        <td>如果在下拉列表中未找到可用的存储类，请联系 <b>平台管理员</b> 添加一个。</td>
      </tr>

      <tr>
        <td nowrap><b>连接配置</b></td>
        <td><b>指定主机端口</b></td>
        <td>当选择外部集群访问时，此配置选项出现。<br /><b>注意</b>: 更新实例时，端口不支持交换。如果需要交换端口，您可以先更新为另一个未使用的端口，然后重新指定。</td>
      </tr>

      <tr>
        <td rowspan="2"><b>调度配置</b></td>
        <td><b>节点标签</b></td>
        <td>通过标签筛选当前集群中可用的节点。Pods 将被调度到可用节点上。<br /><b>注意</b>: 实例创建后，此配置不再可修改。</td>
      </tr>

      <tr>
        <td><b>Pod 容忍</b></td>
        <td>如果可用节点有污点，只有具有容忍的 Pods 才能容忍这些污点，并可调度到匹配 Pod 容忍和节点污点的节点。匹配规则如下： <ul><li><b>相等</b>: 当 Pod 容忍的 <i>key</i>、<i>value</i> 和 <i>effect</i> 与节点污点的对应值完全匹配时，Pod 将容忍节点污点。</li><li><b>存在</b>: 当 Pod 容忍的 <i>key</i> 和 <i>effect</i> 与节点污点的对应值一致时，Pod 将容忍节点污点。</li></ul><b>描述</b>: effect 决定不容忍节点污点的 Pods 是否会被分配到有污点的节点上。例如，如果 effect 为 NoExecute，只有容忍污点的 Pods 才能被调度，同时已经不容忍污点的 Pods 会被驱逐。有关匹配规则的更多信息，请参阅 <a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration/">Kubernetes 官方文档</a>。</td>
      </tr>
    </table>

    5. 点击 **创建**。等待实例状态变更为 **运行中**，表示实例已成功创建。

    6. 进行消息传递。
  </Tab>
</Tabs>

<Directive type="info" title="提示">
  有关业务应用程序访问 RabbitMQ 实例的连接方式，请参阅 [选择连接地址并配置连接方式](../how_to/10-access)。
</Directive>
