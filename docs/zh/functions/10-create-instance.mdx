---
weight: 10
---

# 创建实例

RabbitMQ 作为一款热门的消息队列中间件，具备高效可靠的消息异步传递机制，主要用于不同系统间的数据交流和传递，在企业解决方案、金融支付、电信、电子商务、社交、即时通信、视频、物联网、车联网等众多领域都有广泛应用。

在当前版本，支持以下版本的 RabbitMQ: `3.8.16`，`3.12`。在创建实例时，只能选择这两个版本。以下创建实例，使用 `3.12` 作为示例。

<Directive type="tip" title="建议">
在选择版本时，建议选择最新的支持版本。`3.12` 有如下优势:
1. `3.12` 支持了生产可用的仲裁队列；另外，社区修复了很多 Bug，性能在 3.12 也得到巨大的提升。
2. `3.8.x` 会逐步下线，如果现在使用 `3.8.x` 系列，后续还涉及到版本升级，可能会影响到业务的使用。
</Directive>

## 创建 RabbitMQ 实例

### 前提条件

* 请确保当前集群存在可用存储类，且可用空间充足。

### 操作步骤

<Tabs>

<Tab label="CLI">

通过 CLI 创建 RabbitMQ 实例:

```bash
cat << EOF | kubectl -n default create -f -
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rrrr
spec:
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/name: cluster-in
          topologyKey: kubernetes.io/hostname
  persistence:
    storage: 1Gi
    storageClassName: sc-topolvm
  rabbitmq:
    additionalConfig: |-
      channel_max=1000
      cluster_keepalive_interval=10000
      collect_statistics=none
      collect_statistics_interval=5000
      default_vhost=/
      delegate_count=16
      disk_free_limit.absolute=50MB
      handshake_timeout=10000
      heartbeat=60
      max_message_size=134217728
      mirroring_sync_batch_size=4096
      mnesia_table_loading_retry_limit=10
      mnesia_table_loading_retry_timeout=30000
      num_acceptors.tcp=10
      queue_index_embed_msgs_below=4096
      raft.wal_max_size_bytes=64000000
      vm_memory_calculation_strategy=allocated
      vm_memory_high_watermark.relative=0.4
      vm_memory_high_watermark_paging_ratio=0.5
  replicas: 3
  resources:
    limits:
      cpu: 1
      memory: 2Gi
    requests:
      cpu: 1
      memory: 2Gi
  service:
    type: ClusterIP
  upgradeOption:
    autoUpgrade: false
  version: "3.12"
EOF
```

> 具体字段信息，请查看 [RabbitMQ API 文档](../apis/kubernetes_apis/rabbitmq/rabbitmq)。

在实例创建之后，可通过如下命令查看实例：

```bash
$ kubectl -n default get rabbitmqclusters
NAME   AGE
rrrr   74s
```

可通过如下定制命令来批量查看实例的状态:

```bash
$ kubectl -n default get rabbitmqclusters rrrr -o custom-columns='NAME:.metadata.name,PHASE:.status.phase,USER SECRET:.status.defaultUser.secretReference.name'
NAME   PHASE    USER SECRET
rrrr   Active   rrrr-default-user
```

输出表格字段含义如下：

| 字段        | 说明                                |
|:------------|:------------------------------------|
| NAME        | 实例名称                            |
| PHASE       | 实例状态，实例可能处于以下状态：<ul><li>`Creating`: 实例正在创建资源，初始化集群</li><li>`Updating`: 正在更新实例配置</li><li>`Active`: 实例正处于服务状态</li><li>`Failed`: 实例在初始化或更新过程中出错了</li><li>`Unknown`: 实例处于无法识别的状态</li><li>`Paused`: 实例已暂停，相关Pod 已经关闭</li></ul> |
| USER SECRET | 存储了默认用户账户信息的 secret     |

</Tab>

<Tab label="Web Console">

1. 在左侧导航栏中，单击 **RabbitMQ**。

2. 单击 ***命名空间的名称***。
2. 单击 **创建 RabbitMQ 实例**。
4. 参考以下说明配置相关参数。

 <table>
    <tr>
        <th nowrap>配置</th>
        <th>配置项</th>
        <th>说明</th>
    </tr>
    <tr>
        <td><b>参数配置</b></td>
        <td><b>参数模板</b></td>
        <td>可选择系统或自定义参数模板，自定义参数模板请参考 <a href="">参数模板</a>。</td>
    </tr>
    <tr>
        <td nowrap><b>资源配置</b></td>
        <td><b>存储类</b></td>
        <td>如果下拉列表中无可用存储类，请联系 <b>平台管理员</b> 添加。</td>
    </tr>
    <tr>
        <td nowrap><b>连接配置</b></td>
        <td><b>指定主机端口</b></td>
        <td>当选择集群外访问时，出现该配置项。<br/><b>注意</b>：更新实例时，端口不支持互换，若您需要交换端口，可以先更新为其他未被占用端口，再重新指定。</td>
    </tr>
    <tr>
        <td rowspan="2"><b>调度配置</b></td>
        <td><b>节点标签</b></td>
        <td>通过标签筛选出当前集群中的可用节点。Pod 将被调度到可用节点上。 <br/><b>注意</b>：实例创建后，该配置不再允许修改。</td>
    </tr>
    <tr>
        <td><b>Pod 容忍</b></td>
        <td> 如果可用节点设置了污点，只有设置了 Pod 容忍，Pod 才会容忍这些污点，且有可能会被调度到 Pod 容忍与节点污点相匹配的节点上。匹配规则如下。<ul><li><b>Equal</b>：当 Pod 容忍的 <i>key</i>、<i>value</i>、<i>effect</i> 和节点污点中所设值完全一致时，Pod 会容忍节点污点。 </li><li><b>Exists</b>：当 Pod 容忍的 <i>key</i>、<i>effect</i> 和节点污点中所设值保持一致时，Pod 会容忍节点污点。</li></ul><b>说明</b>：effect 决定了未容忍节点污点的 Pod 是否会被分配到设置了污点的节点上。例如，effect 为 NoExecute 表示只能调度容忍污点的 Pod，且会驱逐已经在该节点上运行但不容忍污点的 Pod。更多关于匹配规则的信息，参见  <a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration/" >Kubernetes 官方文档</a>。</td>
    </tr>
</table>

5. 单击 **创建**。待实例状态变为 **运行中**，实例创建成功。

6. 进行消息投递。
</Tab>

</Tabs>

<Directive type="info" title="提示">
业务应用访问 RabbitMQ 实例的连接方式，请参考 [选择连接地址并配置连接方式](../how_to/10-access)。
</Directive>
